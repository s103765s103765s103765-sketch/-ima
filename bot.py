import discord
from discord.ext import commands, tasks
import os
import asyncio
import itertools

# ----------------------------------------
# 1. ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ã®ãƒˆãƒ¼ã‚¯ãƒ³èª­ã¿è¾¼ã¿ã¨ãƒã‚§ãƒƒã‚¯
# ----------------------------------------
# Renderã®ç’°å¢ƒå¤‰æ•° 'DISCORD_BOT_TOKEN' ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å€¤ã‚’ä½¿ã„ã¾ã™ã€‚
BOT_TOKEN = os.environ.get("DISCORD_BOT_TOKEN")

# ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€ãƒ­ã‚°ã«æ˜ç¢ºãªã‚¨ãƒ©ãƒ¼ã‚’å‡ºã—ã¦çµ‚äº†ã—ã¾ã™ã€‚
if not BOT_TOKEN:
    print("ğŸš¨ [FATAL ERROR] ç’°å¢ƒå¤‰æ•° 'DISCORD_BOT_TOKEN' ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
    print("Renderã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
    # ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã•ã›ã‚‹ã“ã¨ã§ã€RenderãŒå•é¡Œã‚’èªè­˜ã§ãã¾ã™ã€‚
    exit(1)

# ----------------------------------------
# 2. Botã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨ã‚¤ãƒ³ãƒ†ãƒ³ãƒˆ
# ----------------------------------------
# ä»Šå›ã®Botã¯ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã‚ãªã„ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¤ãƒ³ãƒ†ãƒ³ãƒˆã§ååˆ†ã§ã™ã€‚
# ãŸã ã—ã€è­¦å‘Šã‚’æ¶ˆã™ãŸã‚ã«æ˜ç¤ºçš„ã«è¨­å®šã—ã¾ã™ã€‚
intents = discord.Intents.default()
# ã‚³ãƒãƒ³ãƒ‰ ( !help ãªã© ) ã‚’ä½¿ã†å ´åˆã¯ intents.message_content = True ãŒå¿…è¦ã§ã™ã€‚

# command_prefixã¯ä½¿ã‚ãªãã¦ã‚‚è¨­å®šãŒå¿…è¦ã§ã™
bot = commands.Bot(command_prefix="!", intents=intents)

status_list = [
    "ã•ã„ã¤ã‚ˆã‚ã‚‰ã—ãŸã„ã•ã",
    "imaã§ã™ã‚ˆ",
    "discordã•ãƒ¼ã°ãƒ¼ã¯ã„ã£ã¦ã­",
    "ãã‚‡ã†ã®ã”ã¯ã‚“ã¯ã‚„ãã«ãww"
]

# ----------------------------------------
# 3. ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã¨ã‚¿ã‚¹ã‚¯ã®é–‹å§‹
# ----------------------------------------
@bot.event
async def on_ready():
    print(f"âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ: {bot.user} ({bot.user.id})")
    
    # BotãŒæº–å‚™å®Œäº†ã—ã¦ã‹ã‚‰ã‚¿ã‚¹ã‚¯ã‚’é–‹å§‹ã—ã¾ã™
    if not change_status.is_running():
        change_status.start()

# ----------------------------------------
# 4. å®‰å®šã—ãŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã‚¿ã‚¹ã‚¯
# ----------------------------------------
# @tasks.loop(minutes=1) ã§1åˆ†ã”ã¨ã«ã“ã®é–¢æ•°å…¨ä½“ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
@tasks.loop(minutes=1)
async def change_status():
    try:
        # current_loop ã‚’ä½¿ã£ã¦ãƒªã‚¹ãƒˆã‚’å¾ªç’°ã•ã›ã‚‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨ˆç®—
        index = change_status.current_loop % len(status_list)
        current_status = status_list[index]
        
        # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã®å®Ÿè¡Œ
        activity = discord.Game(name=current_status)
        # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ 'online' ã«è¨­å®š
        await bot.change_presence(status=discord.Status.online, activity=activity)
        print(f"[STATUS CHANGE] ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´å®Œäº†: {current_status}")

    except Exception as e:
        # ã‚¿ã‚¹ã‚¯å†…ã§äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€ã‚¿ã‚¹ã‚¯ã‚’åœæ­¢ã›ãšãƒ­ã‚°ã«è¨˜éŒ²ã—ã¾ã™
        print(f"âŒ [TASK ERROR] change_statusãƒ«ãƒ¼ãƒ—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")

# ----------------------------------------
# 5. Botã®å®Ÿè¡Œ
# ----------------------------------------
# ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®å†è©¦è¡Œã¯discord.pyãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒè¡Œã†ãŸã‚ã€ã‚·ãƒ³ãƒ—ãƒ«ã«å®Ÿè¡Œã—ã¾ã™ã€‚
try:
    bot.run(BOT_TOKEN)
except discord.errors.LoginFailure:
    print("âŒ ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã§ã™ã€‚Renderã®ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
except Exception as e:
    print(f"âŒ äºˆæœŸã›ã¬è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ã«ã‚ˆã‚ŠBotãŒçµ‚äº†ã—ã¾ã—ãŸ: {e}")
